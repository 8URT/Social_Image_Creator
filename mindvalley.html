<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mindvalley-style Image Creator</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Kumbh Sans for headlines and main titles -->
  <link href="https://fonts.googleapis.com/css2?family=Kumbh+Sans:wght@500;700;800;900&display=swap" rel="stylesheet" />
  <!-- Fira Sans for sub-headings and body text -->
  <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@500;700;800&display=swap" rel="stylesheet" />

  <script src="https://cdn.tailwindcss.com"></script>
<script>
(function() {
  'use strict';

  const CONFIG = {
    expectedHash: "6373f7e8a5733aa1b875ec0e46235b67b018e8fe239e47bc35d6d9b792cc3b2c",
    expiryDays: 7, // number of days before password expires
    styles: {
      overlay: {
        position: 'fixed',
        top: '0',
        left: '0',
        width: '100%',
        height: '100%',
        background: 'linear-gradient(135deg, #1a202c 0%, #2d3748 100%)',
        display: 'flex',
        justifyContent: 'center',
        alignItems: 'center',
        zIndex: '10000',
        fontFamily: "'Fira Sans', sans-serif"
      },
      container: {
        background: '#2d3748',
        padding: '40px',
        borderRadius: '20px',
        boxShadow: '0 20px 60px rgba(0,0,0,0.5)',
        textAlign: 'center',
        minWidth: '300px',
        border: '1px solid #4a5568'
      },
      title: {
        color: '#f7fafc',
        marginBottom: '30px',
        fontSize: '28px',
        fontWeight: '500', // Updated font weight
        margin: '0 0 30px 0'
      },
      input: {
        width: '100%',
        padding: '15px 20px',
        background: '#1a202c',
        border: '2px solid #4a5568',
        borderRadius: '12px',
        color: '#f7fafc',
        fontSize: '16px',
        marginBottom: '15px',
        transition: 'all 0.3s ease',
        boxSizing: 'border-box',
        outline: 'none'
      },
      inputFocus: {
        borderColor: '#66aaff',
        boxShadow: '0 0 0 3px rgba(102, 170, 255, 0.3)'
      },
      button: {
        width: '100%',
        padding: '15px',
        background: 'linear-gradient(135deg, #66aaff 0%, #4299e1 100%)',
        border: 'none',
        borderRadius: '12px',
        color: '#f7fafc',
        fontSize: '16px',
        fontWeight: '500', // Updated font weight
        cursor: 'pointer',
        transition: 'all 0.3s ease'
      },
      buttonHover: {
        transform: 'translateY(-2px)',
        boxShadow: '0 10px 25px rgba(102, 170, 255, 0.4)'
      },
      error: {
        color: '#fc8181',
        fontSize: '14px',
        marginTop: '10px',
        minHeight: '20px'
      }
    }
  };

  async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  }

  function applyStyles(element, styles) {
    Object.assign(element.style, styles);
  }

  function createLoginOverlay() {
    const overlay = document.createElement('div');
    overlay.id = 'passwordProtectionOverlay';
    applyStyles(overlay, CONFIG.styles.overlay);

    const container = document.createElement('div');
    applyStyles(container, CONFIG.styles.container);

    const title = document.createElement('h2');
    title.textContent = 'Enter Password';
    applyStyles(title, CONFIG.styles.title);

    const input = document.createElement('input');
    input.type = 'password';
    input.id = 'passwordProtectionInput';
    input.placeholder = 'Password';
    applyStyles(input, CONFIG.styles.input);

    input.addEventListener('focus', () => {
      applyStyles(input, CONFIG.styles.inputFocus);
    });
    input.addEventListener('blur', () => {
      input.style.borderColor = '#4a5568';
      input.style.boxShadow = 'none';
    });

    const button = document.createElement('button');
    button.textContent = 'Login';
    button.id = 'passwordProtectionButton';
    applyStyles(button, CONFIG.styles.button);

    button.addEventListener('mouseenter', () => {
      applyStyles(button, CONFIG.styles.buttonHover);
    });
    button.addEventListener('mouseleave', () => {
      button.style.transform = 'translateY(0)';
      button.style.boxShadow = 'none';
    });

    const errorMsg = document.createElement('div');
    errorMsg.id = 'passwordProtectionError';
    applyStyles(errorMsg, CONFIG.styles.error);

    container.appendChild(title);
    container.appendChild(input);
    container.appendChild(button);
    container.appendChild(errorMsg);
    overlay.appendChild(container);

    return { overlay, input, button, errorMsg };
  }

  async function checkPassword(input, errorMsg, overlay) {
    const password = input.value;
    
    if (!password) {
      errorMsg.textContent = 'Please enter a password';
      return;
    }

    try {
      const hash = await hashPassword(password);
      
      if (hash === CONFIG.expectedHash) {
        // ✅ Save expiry timestamp
        const expiry = Date.now() + CONFIG.expiryDays * 24 * 60 * 60 * 1000;
        localStorage.setItem('passwordVerifiedUntil', expiry.toString());

        overlay.style.display = 'none';
        document.body.style.overflow = 'auto';
        input.value = '';
        setTimeout(() => {
          if (overlay.parentNode) {
            overlay.parentNode.removeChild(overlay);
          }
        }, 500);
      } else {
        errorMsg.textContent = 'Incorrect password';
        input.value = '';
        input.focus();
        input.style.animation = 'shake 0.5s ease-in-out';
        setTimeout(() => {
          input.style.animation = '';
        }, 500);
      }
    } catch (error) {
      console.error('Password checking error:', error);
      errorMsg.textContent = 'An error occurred. Please try again.';
    }
  }

  function addShakeAnimation() {
    const style = document.createElement('style');
    style.textContent = `
      @keyframes shake {
        0%, 20%, 40%, 60%, 80%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      }
    `;
    document.head.appendChild(style);
  }

  function initializePasswordProtection() {
    // ✅ Check expiry timestamp
    const expiry = localStorage.getItem('passwordVerifiedUntil');
    if (expiry && Date.now() < parseInt(expiry, 10)) {
      return; // still valid, skip overlay
    } else {
      localStorage.removeItem('passwordVerifiedUntil'); // expired → reset
    }

    document.body.style.visibility = 'hidden';
    document.body.style.overflow = 'hidden';
    
    const { overlay, input, button, errorMsg } = createLoginOverlay();
    document.body.appendChild(overlay);
    
    document.body.style.visibility = 'visible';
    
    button.addEventListener('click', () => {
      checkPassword(input, errorMsg, overlay);
    });
    
    input.addEventListener('keypress', (event) => {
      if (event.key === 'Enter') {
        checkPassword(input, errorMsg, overlay);
      }
    });
    
    setTimeout(() => {
      input.focus();
    }, 100);
    
    addShakeAnimation();
  }

  // ✅ Optional logout function
  window.logoutPasswordProtection = function() {
    localStorage.removeItem('passwordVerifiedUntil');
    location.reload();
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePasswordProtection);
  } else {
    initializePasswordProtection();
  }

})();
</script>

  <style>
    /* Dark Mode Colors */
    body {
      background-color: #1a202c; /* Dark background for the body */
      color: #f7fafc; /* Light text color for the body */
    }
    .gradient-bg {
      background: #1a202c; /* Consistent dark background for the main wrapper */
    }
    .bg-white { /* This class is now used for control panel, renamed for clarity */
      background-color: #2d3748; /* Darker background for panels */
      color: #f7fafc; /* Light text for panels */
    }
    /* Updated title color */
    .text-gray-800 {
      color: #3F51B5; /* Social Media Image Creator title color */
    }
    .border-gray-200 { /* Used for control panel border */
      border-color: #4a5568; /* Darker borders */
    }
    .border-gray-300 { /* Used for input borders */
      border-color: #718096; /* Slightly lighter dark borders for inputs */
    }
    /* Adjusted text colors for better visibility in dark mode */
    .text-gray-600 {
      color: #cbd5e0; /* Lighter gray for labels and tips */
    }
    .text-gray-500 {
        color: #a0aec0; /* Slightly darker gray for range slider values */
    }
    .bg-gray-100 { /* Used for pro tip box */
      background-color: #4a5568; /* Darker background for info boxes */
      color: #f7fafc; /* Light text for info boxes */
    }
    .text-blue-600 {
      color: #66aaff; /* Brighter blue for accents */
    }
    .focus\:border-blue-500 {
      border-color: #66aaff; /* Blue border on focus */
    }
    .focus\:ring-blue-100 {
      box-shadow: 0 0 0 0.2rem rgba(102, 170, 255, 0.25); /* Blue ring on focus */
    }
    .hover\:border-blue-500 {
      border-color: #66aaff; /* Blue border on hover */
    }
    .hover\:bg-blue-50 {
      background-color: rgba(102, 170, 255, 0.05); /* Very light blue background on hover */
    }
    /* Gradient buttons for dark mode */
    .import-button, .generate-button, .download-button {
      background: linear-gradient(135deg, #66aaff 0%, #4299e1 100%);
      color: #f7fafc; /* Light text for buttons */
    }
    .import-button:hover, .generate-button:hover, .download-button:hover {
      box-shadow: 0 5px 15px rgba(102, 170, 255, 0.4); /* Blue shadow on hover */
      -webkit-transform: translateY(-1px);
      transform: translateY(-1px);
    }
    .ring-blue-500 {
      box-shadow: 0 0 0 3px rgba(102, 170, 255, 0.5);
    }

    /* New style for the Image Size Mode button */
    #imageSizeMode {
        background: linear-gradient(135deg, #9C27B0 0%, #2196F3 100%); /* Purple to Blue gradient */
        color: #f7fafc; /* Light text color */
        border: none; /* Remove border */
        outline: none; /* Remove default outline */
        box-shadow: 0 0 0 0.1rem rgba(156, 39, 176, 0.5); /* Subtle focus ring */
        transition: all 0.3s ease; /* Ensure smooth transitions for focus */
    }

    #imageSizeMode:hover {
        box-shadow: 0 5px 15px rgba(156, 39, 176, 0.4); /* Matching shadow on hover */
        transform: translateY(-1px);
    }

    /* Canvas specific styles */
    #canvas {
      max-width: 100%;
      height: auto;
      background-color: #4a5568; /* Darker canvas background for contrast */
      border: 1px solid #718096; /* Subtle border for the canvas */
    }

    /* Style for the drag-over state */
    .drag-over {
        border-color: #66aaff !important; /* Blue border for drag over */
        background-color: #2c5282 !important; /* Darker blue background for drag over */
        color: #f7fafc !important; /* Ensure text is visible */
    }

    /* Range slider dark mode styles */
    input[type="range"] {
        background-color: #4a5568; /* Darker track for range slider */
    }
    input[type="range"]::-webkit-slider-thumb {
      background: #66aaff;
      border: 1px solid #4299e1;
    }
    input[type="range"]::-moz-range-thumb {
      background: #66aaff;
      border: 1px solid #4299e1;
    }
    input[type="range"]::-ms-thumb {
      background: #66aaff;
      border: 1px solid #4299e1;
    }
    /* Input field background and text */
    input[type="text"], input[type="number"], textarea, select {
      background-color: #2d3748;
      color: #f7fafc;
      border-color: #4a5568;
    }
    input[type="text"]::placeholder, textarea::placeholder {
      color: #a0aec0; /* Muted placeholder text */
    }
    /* Updated drop zone background */
    #imageDropZone {
        background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%); /* Darker gradient */
    }
    #imageDropZone:hover {
        border-color: #718096; /* Darker hover border */
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); /* Darker shadow */
    }
  </style>
</head>
<!-- Updated font weight to Medium (500) for all text -->
<body class="min-h-screen gradient-bg p-4 font-['Kumbh_Sans']">
  <div class="max-w-5xl mx-auto">
    <div class="text-gray-800 text-center py-2 mb-3">
      <h1 class="text-4xl font-medium">Mindvalley-style Image Creator</h1>
    </div>

    <div class="rounded-3xl overflow-hidden">
      <div class="grid lg:grid-cols-[1fr_320px] gap-4 p-4">
        <div class="flex justify-center items-start">
          <canvas id="canvas" width="1000" height="1250" class="rounded-xl shadow-xl bg-white"></canvas>
        </div>

        <div class="bg-white p-5 rounded-2xl shadow-lg border border-gray-200">
          <div id="imageDropZone" class="border-4 border-dotted border-gray-400 rounded-2xl p-5 text-center mb-4 transition-all duration-300 cursor-pointer hover:border-gray-500 hover:shadow-lg hover:-translate-y-1">
              <input type="file" id="imageUpload" accept="image/*" class="hidden" />
              <p class="text-base text-gray-600 font-medium mb-3">Drag & Drop your image here</p>
              <button type="button" onclick="document.getElementById('imageUpload').click()" class="import-button text-white px-4 py-2 rounded-full font-medium transition-all duration-300 hover:-translate-y-1 text-sm">or Click to Select Image</button>
              <div class="mt-3 p-3 bg-gray-100 rounded-xl text-xs text-gray-600 leading-relaxed">
                <span class="text-blue-600 font-medium">Pro Tip:</span> You can also paste images directly! Copy an image (Ctrl+C or Cmd+C) and paste it here (Ctrl-V or Cmd-V).
              </div>
          </div>

          <button type="button" id="imageSizeMode" class="w-full px-4 py-2 mb-4 rounded-xl font-medium transition-all duration-300 hover:-translate-y-1 text-sm">
            Fill Frame (Cover)
          </button>

          <div id="imagePositionControls" class="space-y-3 mb-4">
            <div>
              <label for="imageOffsetX" class="block font-medium text-gray-600 mb-1 text-xs">Image X Offset:</label>
              <input type="range" id="imageOffsetX" min="-500" max="500" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
              <div class="text-xs text-gray-500 text-right"><span id="imageOffsetXValue">0</span> px</div>
            </div>
            <div>
              <label for="imageOffsetY" class="block font-medium text-gray-600 mb-1 text-xs">Image Y Offset:</label>
              <input type="range" id="imageOffsetY" min="-500" max="500" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
              <div class="text-xs text-gray-500 text-right"><span id="imageOffsetYValue">0</span> px</div>
            </div>
            <div>
              <label for="imageZoom" class="block font-medium text-gray-600 mb-1 text-xs">Image Zoom:</label>
              <input type="range" id="imageZoom" min="1" max="300" value="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
              <div class="text-xs text-gray-500 text-right"><span id="imageZoomValue">100</span> %</div>
            </div>
          </div>

          <div class="space-y-4">
            <div>
                <label for="fontStyleSelect" class="block font-medium text-gray-600 mb-1 text-xs">Font Style:</label>
                <select id="fontStyleSelect" class="w-full px-3 py-2 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300 text-sm">
                    <option value="Kumbh Sans" selected>Kumbh Sans (Default)</option>
                    <option value="Fira Sans">Fira Sans</option>
                </select>
            </div>
            <div>
              <label for="titleFontSize" class="block font-medium text-gray-600 mb-1 text-xs">Title Font Size:</label>
              <input type="range" id="titleFontSize" min="40" max="150" value="80" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
              <div class="text-xs text-gray-500 text-right"><span id="titleFontSizeValue">80</span> px</div>
            </div>
            <!-- New: Undertitle Font Size Slider -->
            <div>
                <label for="undertitleFontSize" class="block font-medium text-gray-600 mb-1 text-xs">Undertitle Font Size:</label>
                <input type="range" id="undertitleFontSize" min="12" max="60" value="30" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <div class="text-xs text-gray-500 text-right"><span id="undertitleFontSizeValue">30</span> px</div>
            </div>
            <!-- New: Author Font Size Slider -->
            <div>
                <label for="authorFontSize" class="block font-medium text-gray-600 mb-1 text-xs">Author Font Size:</label>
                <input type="range" id="authorFontSize" min="12" max="60" value="25" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <div class="text-xs text-gray-500 text-right"><span id="authorFontSizeValue">25</span> px</div>
            </div>
            <div>
              <input type="text" id="title" placeholder="Main title here..." maxlength="200" class="w-full px-3 py-2 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300 text-sm" />
            </div>
            <div>
              <input type="text" id="undertitle" placeholder="Undertitle" maxlength="60" class="w-full px-3 py-2 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300 text-sm" />
            </div>

            <div>
              <input type="text" id="author" placeholder="Author name" maxlength="60" class="w-full px-3 py-2 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300 text-sm" />
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div class="flex items-center">
                    <input type="checkbox" id="ctaToggle" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked />
                    <label for="ctaToggle" class="block font-medium text-gray-600 text-xs">Call to Action</label>
                </div>
                <div class="col-span-1">
                    <input type="text" id="ctaText" placeholder="CTA text (e.g., READ MORE)" value="LEARN MORE" maxlength="30" class="w-full px-3 py-2 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300 text-sm" />
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div class="col-span-1">
                    <label class="block font-medium text-gray-600 mb-1 text-xs">CTA Button Color:</label>
                    <input type="color" id="ctaColorPicker" value="#FF0000" class="w-full h-8 border-2 border-gray-300 rounded-md cursor-pointer" />
                </div>
                <div class="col-span-1">
                    <label class="block font-medium text-gray-600 mb-1 text-xs">Subtitle BG Color:</label>
                    <select id="subtitleBackgroundColorPresets" class="w-full px-2 py-1 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300 text-sm">
                        <option value="none" selected>No Background</option>
                        <option value="#DD3333">Our Red</option>
                        <option value="#000000">Black</option>
                        <option value="#FFFFFF">White</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block font-medium text-gray-600 mb-1 text-xs">Gradient Start Color:</label>
                    <input type="color" id="gradientStartColor" value="#000000" class="w-full h-8 border-2 border-gray-300 rounded-md cursor-pointer" />
                </div>
                <div>
                    <label class="block font-medium text-gray-600 mb-1 text-xs">Gradient End Color:</label>
                    <input type="color" id="gradientEndColor" value="#000000" class="w-full h-8 border-2 border-gray-300 rounded-md cursor-pointer" />
                </div>
            </div>
            <div>
              <label for="gradientOpacity" class="block font-medium text-gray-600 mb-1 text-xs">Gradient Opacity:</label>
              <input type="range" id="gradientOpacity" min="0" max="100" value="90" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
              <div class="text-xs text-gray-500 text-right"><span id="gradientOpacityValue">90</span> %</div>
            </div>

            <div class="grid grid-cols-1 gap-2">
                <div>
                    <label class="block font-medium text-gray-600 mb-1 text-xs">Background Blend Mode:</label>
                    <select id="backgroundBlendMode" class="w-full px-3 py-2 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-100 transition-all duration-300 text-sm">
                        <option value="source-over" selected>Normal</option>
                        <option value="multiply">Multiply</option>
                        <option value="screen">Screen</option>
                        <option value="overlay">Overlay</option>
                        <option value="darken">Darken</option>
                        <option value="lighten">Lighten</option>
                    </select>
                </div>
            </div>
            
            <div class="flex gap-3 pt-4">
              <button onclick="drawCanvas()" class="generate-button flex-1 text-white px-4 py-3 rounded-xl font-medium transition-all duration-300 hover:-translate-y-1 hover:shadow-lg text-sm">Generate Image</button>
              <button onclick="downloadImage()" class="download-button flex-1 text-white px-4 py-3 rounded-xl font-medium transition-all duration-300 hover:-translate-y-1 hover:shadow-lg text-sm">Download Image</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const imageInput = document.getElementById('imageUpload');
    const titleInput = document.getElementById('title');
    const undertitleInput = document.getElementById('undertitle');
    const authorInput = document.getElementById('author');
    const ctaToggle = document.getElementById('ctaToggle');
    const ctaText = document.getElementById('ctaText');

    const subtitleBackgroundColorPresets = document.getElementById('subtitleBackgroundColorPresets');
    const ctaColorPicker = document.getElementById('ctaColorPicker');
    const gradientStartColorPicker = document.getElementById('gradientStartColor');
    const gradientEndColorPicker = document.getElementById('gradientEndColor');
    const gradientOpacityInput = document.getElementById('gradientOpacity');
    const gradientOpacityValueSpan = document.getElementById('gradientOpacityValue');

    const backgroundBlendMode = document.getElementById('backgroundBlendMode');

    const imageSizeModeButton = document.getElementById('imageSizeMode');
    let imageCoverMode = true;

    const imageOffsetXInput = document.getElementById('imageOffsetX');
    const imageOffsetYInput = document.getElementById('imageOffsetY');
    const imageZoomInput = document.getElementById('imageZoom');
    const imageOffsetXValueSpan = document.getElementById('imageOffsetXValue');
    const imageOffsetYValueSpan = document.getElementById('imageOffsetYValue');
    const imageZoomValueSpan = document.getElementById('imageZoomValue');

    const titleFontSizeInput = document.getElementById('titleFontSize');
    const titleFontSizeValueSpan = document.getElementById('titleFontSizeValue');
    
    // New: Undertitle and Author Font Size controls
    const undertitleFontSizeInput = document.getElementById('undertitleFontSize');
    const undertitleFontSizeValueSpan = document.getElementById('undertitleFontSizeValue');
    const authorFontSizeInput = document = document.getElementById('authorFontSize');
    const authorFontSizeValueSpan = document.getElementById('authorFontSizeValue');


    let currentImageOffsetX = 0;
    let currentImageOffsetY = 0;
    let currentImageZoom = 100;
    let currentTitleFontSize = 80;
    // New: current font sizes for undertitle and author
    let currentUndertitleFontSize = 30;
    let currentAuthorFontSize = 25;

    const fontStyleSelect = document.getElementById('fontStyleSelect');

    let uploadedImage = null;

    const logo = new Image();
    logo.src = 'assets/logo.png';
    let logoLoaded = false;
    logo.onload = () => {
      logoLoaded = true;
      drawCanvas();
    };
    logo.onerror = () => {
      console.warn("Main logo (logo.png) failed to load. Please check its path in the 'assets' folder.");
      logoLoaded = false;
      drawCanvas();
    };

    const logo2 = new Image();
    logo2.src = 'assets/Asset 2@1.png';
    let logo2Loaded = false;
    logo2.onload = () => {
      logo2Loaded = true;
      drawCanvas();
    };
    logo2.onerror = () => {
      console.warn("Top-right logo (Asset 2@1.png) failed to load. Please check its path in the 'assets' folder.");
      logo2Loaded = false;
      drawCanvas();
    };

    function handlePaste(e) {
      const items = e.clipboardData?.items;
      if (!items) return;

      for (let item of items) {
        if (item.type.startsWith('image/')) {
          e.preventDefault();
          const file = item.getAsFile();
          if (file) {
            loadImageFromFile(file);
          }
          break;
        }
      }
    }

    function loadImageFromFile(file) {
      if (!file.type.startsWith('image/')) {
        alert("Please upload an image file (e.g., JPEG, PNG, GIF).");
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => {
          uploadedImage = img;
          resetImageTransforms();
          drawCanvas();
        };
        img.onerror = () => {
          alert("Could not load image. Please try another file.");
          uploadedImage = null;
          drawCanvas();
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    }

    document.addEventListener('paste', handlePaste);
    document.getElementById('imageDropZone').addEventListener('paste', handlePaste);
    document.getElementById('imageDropZone').setAttribute('tabindex', '0');

    const imageDropZone = document.getElementById('imageDropZone');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      imageDropZone.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults (e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      imageDropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      imageDropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
      imageDropZone.classList.add('drag-over');
    }

    function unhighlight() {
      imageDropZone.classList.remove('drag-over');
    }

    imageDropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;

      if (files.length > 0) {
        loadImageFromFile(files?.[0]);
      }
    }

    imageInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) {
        uploadedImage = null;
        drawCanvas();
        return;
      }
      loadImageFromFile(file);
    });

    // Combined event listeners for all controls
    ([
      titleInput, undertitleInput, authorInput, ctaToggle, ctaText,
      subtitleBackgroundColorPresets, ctaColorPicker,
      backgroundBlendMode, gradientStartColorPicker, gradientEndColorPicker,
      imageOffsetXInput, imageOffsetYInput, imageZoomInput, titleFontSizeInput,
      undertitleFontSizeInput, authorFontSizeInput, gradientOpacityInput
    ]).forEach(el => {
      el.addEventListener('input', drawCanvas);
    });

    // New event listeners for font size value displays
    undertitleFontSizeInput.addEventListener('input', (e) => {
        currentUndertitleFontSize = parseInt(e.target.value);
        undertitleFontSizeValueSpan.textContent = currentUndertitleFontSize;
    });

    authorFontSizeInput.addEventListener('input', (e) => {
        currentAuthorFontSize = parseInt(e.target.value);
        authorFontSizeValueSpan.textContent = currentAuthorFontSize;
    });


    imageSizeModeButton.addEventListener('click', () => {
      imageCoverMode = !imageCoverMode;
      imageSizeModeButton.textContent = imageCoverMode ? 'Fit to Frame' : 'Fill Frame (Cover)';
      resetImageTransforms();
      drawCanvas();
    });

    function resetImageTransforms() {
        currentImageOffsetX = 0;
        currentImageOffsetY = 0;
        currentImageZoom = 100;

        imageOffsetXInput.value = 0;
        imageOffsetYInput.value = 0;
        imageZoomInput.value = 100;

        imageOffsetXValueSpan.textContent = 0;
        imageOffsetYValueSpan.textContent = 0;
        imageZoomValueSpan.textContent = 100;
    }

    imageOffsetXInput.addEventListener('input', (e) => {
        currentImageOffsetX = parseInt(e.target.value);
        imageOffsetXValueSpan.textContent = currentImageOffsetX;
        drawCanvas();
    });

    imageOffsetYInput.addEventListener('input', (e) => {
        currentImageOffsetY = parseInt(e.target.value);
        imageOffsetYValueSpan.textContent = currentImageOffsetY;
        drawCanvas();
    });

    imageZoomInput.addEventListener('input', (e) => {
        currentImageZoom = parseInt(e.target.value);
        imageZoomValueSpan.textContent = currentImageZoom;
        drawCanvas();
    });

    titleFontSizeInput.addEventListener('input', (e) => {
        currentTitleFontSize = parseInt(e.target.value);
        titleFontSizeValueSpan.textContent = currentTitleFontSize;
        drawCanvas();
    });

    gradientOpacityInput.addEventListener('input', (e) => {
        gradientOpacityValueSpan.textContent = e.target.value;
        drawCanvas();
    });

    fontStyleSelect.addEventListener('change', () => {
        drawCanvas();
    });

    function hexToRgba(hex, alpha) {
        const bigint = parseInt(hex.slice(1), 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return `rgba(${r},${g},${b},${alpha})`;
    }

    // New and improved rule for French typography to handle monosyllabic words
    function applyFrenchTypographyRules(text) {
        const monosyllabicWords = [
            'le', 'la', 'les', 'l\'', 'un', 'une', 'des', 'de', 'du', 'd\'', 'au', 'aux',
            'à', 'et', 'ou', 'où', 'car', 'donc', 'or', 'ni', 'mais', 'sur', 'sous', 'vers', 'sans', 'avec'
        ];
        
        const regex = new RegExp(`\\b(${monosyllabicWords.join('|')})\\s`, 'gi');
        
        let processedText = text.replace(regex, (match, p1) => {
            // Replace the space with a non-breaking space
            return p1 + '\u00A0';
        });

        // Also handle cases like "C'est l'histoire d'un"
        processedText = processedText.replace(/(\b[a-zA-Z])'\s/g, (match, p1) => {
            return p1 + '\u202F'; // Use narrow non-breaking space for apostrophes
        });

        return processedText;
    }
    
    function roundRect(ctx, x, y, width, height, radius) {
        ctx.beginPath();
        ctx.moveTo(x + radius, y);
        ctx.lineTo(x + width - radius, y);
        ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
        ctx.lineTo(x + width, y + height - radius);
        ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
        ctx.lineTo(x + radius, y + height);
        ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
        ctx.lineTo(x, y + radius);
        ctx.quadraticCurveTo(x, y, x + radius, y);
        ctx.closePath();
        ctx.fill();
    }

    function drawCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        const selectedFont = fontStyleSelect.value;
        let fontStyle = 'normal';
        
        switch (selectedFont) {
            case 'Kumbh Sans':
                fontStyle = 'normal';
                break;
            case 'Fira Sans':
            default:
                fontStyle = 'normal';
                break;
        }

        // === Step 1: Draw Background Image and Gradient ===
        if (uploadedImage) {
            const imgRatio = uploadedImage.width / uploadedImage.height;
            const canvasRatio = canvas.width / canvas.height;

            let mainImgX = 0, mainImgY = 0, mainImgW = canvas.width, mainImgH = canvas.height;

            if (imageCoverMode) {
                if (imgRatio > canvasRatio) {
                    mainImgH = canvas.height;
                    mainImgW = mainImgH * imgRatio;
                } else {
                    mainImgW = canvas.width;
                    mainImgH = mainImgW / imgRatio;
                }
            } else {
                if (imgRatio < canvasRatio) {
                    mainImgH = canvas.height;
                    mainImgW = mainImgH * imgRatio;
                } else {
                    mainImgW = canvas.width;
                    mainImgH = mainImgW / imgRatio;
                }
            }

            const zoomFactor = currentImageZoom / 100;
            mainImgW *= zoomFactor;
            mainImgH *= zoomFactor;

            mainImgX = (canvas.width - mainImgW) / 2;
            mainImgY = (canvas.height - mainImgH) / 2;

            mainImgX += currentImageOffsetX;
            mainImgY += currentImageOffsetY;

            if (!imageCoverMode) {
                ctx.save();
                ctx.filter = 'blur(30px)';
                
                let blurImgW, blurImgH;
                const blurImgRatio = uploadedImage.width / uploadedImage.height;
                const blurCanvasRatio = canvas.width / canvas.height;

                if (blurImgRatio > blurCanvasRatio) {
                    blurImgH = canvas.height;
                    blurImgW = blurImgH * blurImgRatio;
                } else {
                    blurImgW = canvas.width;
                    blurImgH = blurImgW / blurImgRatio;
                }

                blurImgW *= zoomFactor;
                blurImgH *= zoomFactor;

                const blurX = (canvas.width - blurImgW) / 2 + currentImageOffsetX;
                const blurY = (canvas.height - blurImgH) / 2 + currentImageOffsetY;

                ctx.drawImage(uploadedImage, blurX, blurY, blurImgW, blurImgH);
                ctx.filter = 'none';
                ctx.restore();
            }

            ctx.drawImage(uploadedImage, mainImgX, mainImgY, mainImgW, mainImgH);

        } else {
            ctx.fillStyle = '#4a5568';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#a0aec0';
            ctx.font = "500 36px 'Fira Sans', sans-serif";
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText("Drag & Drop, Click to Upload, or Paste Image", canvas.width / 2, canvas.height / 2);
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
        }

        const gradientStartColor = gradientStartColorPicker.value;
        const gradientEndColor = gradientEndColorPicker.value;
        const gradientOpacity = gradientOpacityInput.value / 100;
        const selectedBlendMode = backgroundBlendMode.value;

        ctx.save();
        ctx.globalCompositeOperation = selectedBlendMode;

        const gradient = ctx.createLinearGradient(0, canvas.height * 0.4, 0, canvas.height);
        gradient.addColorStop(0, hexToRgba(gradientStartColor, 0));
        gradient.addColorStop(0.3, hexToRgba(gradientStartColor, gradientOpacity * 0.4));
        gradient.addColorStop(1, hexToRgba(gradientEndColor, gradientOpacity * 0.9));
        
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.restore();

        // === Step 2: Calculate Text Block Height ===
        const paddingX = 50;
        const bottomPadding = 50;
        const subtitleRaw = undertitleInput.value.trim();
        const titleRaw = titleInput.value.trim();
        const authorRaw = authorInput.value.trim();
        const ctaRaw = ctaText.value.trim().toUpperCase();

        let totalTextHeight = 0;
        const verticalSpacing = 20;

        // Measure Title Height
        if (titleRaw.length > 0) {
            const maxTextWidth = canvas.width - (paddingX * 2);
            let titleSize = currentTitleFontSize;
            const tempCtx = canvas.getContext('2d');
            
            function getTitleLines(text, fontSize, maxWidth) {
                const lines = [];
                tempCtx.font = `500 ${fontSize}px 'Kumbh Sans', sans-serif`;
                const words = applyFrenchTypographyRules(text).split(' ');
                let currentLine = '';
                for (let word of words) {
                    const testLine = currentLine + word + ' ';
                    if (tempCtx.measureText(testLine).width > maxWidth && currentLine !== '') {
                        lines.push(currentLine.trim());
                        currentLine = word + ' ';
                    } else {
                        currentLine = testLine;
                    }
                }
                if (currentLine) lines.push(currentLine.trim());
                return lines;
            }

            let titleLines = getTitleLines(titleRaw, titleSize, maxTextWidth);
            while (titleLines.length > 3 && titleSize > 60) {
                titleSize -= 5;
                titleLines = getTitleLines(titleRaw, titleSize, maxTextWidth);
            }
            totalTextHeight += titleLines.length * (titleSize * 1.05);
        }

        // Measure Undertitle Height
        if (subtitleRaw.length > 0) {
            ctx.font = `500 ${currentUndertitleFontSize}px 'Kumbh Sans', sans-serif`;
            const metrics = ctx.measureText(applyFrenchTypographyRules(subtitleRaw));
            totalTextHeight += metrics.actualBoundingBoxDescent + metrics.actualBoundingBoxAscent + verticalSpacing;
        }

        // Measure Author Height
        if (authorRaw.length > 0) {
            ctx.font = `500 ${currentAuthorFontSize}px 'Fira Sans', sans-serif`;
            const metrics = ctx.measureText(applyFrenchTypographyRules(authorRaw));
            totalTextHeight += metrics.actualBoundingBoxDescent + metrics.actualBoundingBoxAscent + verticalSpacing;
        }

        // Measure CTA Button Height
        if (ctaToggle.checked && ctaRaw.length > 0) {
            // Button height is fixed at 60px, with some padding
            totalTextHeight += 60 + 30; 
        }

        // === Step 3: Draw Text and CTA at Calculated Position ===
        const startBlockY = canvas.height - bottomPadding - totalTextHeight;
        let currentY = startBlockY;

        ctx.shadowColor = 'rgba(0,0,0,0.4)';
        ctx.shadowBlur = 4;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;

        // Draw Title (First and largest)
        if (titleRaw.length > 0) {
            const maxTextWidth = canvas.width - (paddingX * 2);
            let titleSize = currentTitleFontSize; 
            const tempCtx = canvas.getContext('2d');
            
            function getTitleLines(text, fontSize, maxWidth) {
                const lines = [];
                tempCtx.font = `500 ${fontSize}px 'Kumbh Sans', sans-serif`;
                const words = applyFrenchTypographyRules(text).split(' ');
                let currentLine = '';
                for (let word of words) {
                    const testLine = currentLine + word + ' ';
                    if (tempCtx.measureText(testLine).width > maxWidth && currentLine !== '') {
                        lines.push(currentLine.trim());
                        currentLine = word + ' ';
                    } else {
                        currentLine = testLine;
                    }
                }
                if (currentLine) lines.push(currentLine.trim());
                return lines;
            }

            let titleLines = getTitleLines(titleRaw, titleSize, maxTextWidth);
            while (titleLines.length > 3 && titleSize > 60) {
                titleSize -= 5;
                titleLines = getTitleLines(titleRaw, titleSize, maxTextWidth);
            }
            
            ctx.font = `500 ${titleSize}px 'Kumbh Sans', sans-serif`;
            ctx.fillStyle = '#ffffff';
            ctx.textBaseline = 'top';
            ctx.textAlign = 'left';
            
            const lineHeight = titleSize * 1.05;
            for (let i = 0; i < titleLines.length; i++) {
                ctx.fillText(titleLines[i], paddingX, currentY + i * lineHeight);
            }
            currentY += titleLines.length * lineHeight;
        }
        
        // Draw Undertitle (Subtitle)
        if (subtitleRaw.length > 0) {
            currentY += verticalSpacing; // Add spacing before subtitle
            const subtitleBgColor = subtitleBackgroundColorPresets.value;
            const subtitleText = applyFrenchTypographyRules(subtitleRaw);
            
            ctx.font = `500 ${currentUndertitleFontSize}px 'Kumbh Sans', sans-serif`;
            const metrics = ctx.measureText(subtitleText);

            if (subtitleBgColor !== 'none') {
                ctx.fillStyle = subtitleBgColor;
                const bgWidth = metrics.width + 30;
                const bgHeight = currentUndertitleFontSize + 10;
                const bgX = paddingX - 15;
                const bgY = currentY - 5;
                roundRect(ctx, bgX, bgY, bgWidth, bgHeight, 5);
            }
            
            // Change undertitle text color to white
            ctx.fillStyle = '#ffffff'; 
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.fillText(subtitleText, paddingX, currentY);
            currentY += metrics.actualBoundingBoxDescent + metrics.actualBoundingBoxAscent;
        }

        // Draw Author
        if (authorRaw.length > 0) {
            currentY += verticalSpacing; // Add spacing before author
            ctx.font = `500 ${currentAuthorFontSize}px 'Fira Sans', sans-serif`;
            // Change author text color to yellow
            ctx.fillStyle = '#FFFF00'; 
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.fillText(applyFrenchTypographyRules(authorRaw), paddingX, currentY);
            const metrics = ctx.measureText(applyFrenchTypographyRules(authorRaw));
            currentY += metrics.actualBoundingBoxDescent + metrics.actualBoundingBoxAscent;
        }

        // Draw CTA Button
        if (ctaToggle.checked && ctaRaw.length > 0) {
            currentY += 30; // Add space before button
            const ctaPadding = 30;
            ctx.font = `500 28px 'Fira Sans', sans-serif`;
            const ctaMetrics = ctx.measureText(ctaRaw);
            const ctaWidth = ctaMetrics.width + (ctaPadding * 2);
            const ctaHeight = 60;
            const ctaX = paddingX;
            const ctaY = currentY;
            const ctaRadius = 30; // More rounded
            
            ctx.fillStyle = ctaColorPicker.value;
            roundRect(ctx, ctaX, ctaY, ctaWidth, ctaHeight, ctaRadius);
            
            ctx.fillStyle = '#ffffff';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            ctx.fillText(ctaRaw, ctaX + ctaPadding, ctaY + ctaHeight / 2);
        }

        ctx.shadowColor = 'transparent';
        ctx.shadowBlur = 0;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;

        // Draw Logos
        const logoHeight = 60;
        const logoPadding = 50;

        // Top-left logo (logo.png)
        if (logoLoaded) {
            const logoWidth = logo.width * (logoHeight / logo.height);
            ctx.drawImage(logo, logoPadding, logoPadding, logoWidth, logoHeight);
        }
        
        // Top-right logo (Asset 2@1.png)
        if (logo2Loaded) {
            const logo2Width = logo2.width * (logoHeight / logo2.height);
            const logo2X = canvas.width - logo2Width - logoPadding;
            ctx.drawImage(logo2, logo2X, logoPadding, logo2Width, logoHeight);
        }
    }

    function downloadImage() {
        const buttonContainer = document.querySelector('.flex.gap-3.pt-4');
        const downloadButton = buttonContainer.querySelector('button:last-child');
        const generateButton = buttonContainer.querySelector('button:first-child');
        const importButton = document.querySelector('.import-button');

        const originalDownloadText = downloadButton.textContent;
        downloadButton.textContent = 'Downloading...';
        downloadButton.disabled = true;
        generateButton.disabled = true;
        importButton.disabled = true;

        try {
            const link = document.createElement('a');
            link.download = 'social-media-image.png';
            link.href = canvas.toDataURL('image/png');

            link.click();

            setTimeout(() => {
                downloadButton.textContent = originalDownloadText;
                downloadButton.disabled = false;
                generateButton.disabled = false;
                importButton.disabled = false;
            }, 2000);
        } catch (error) {
            console.error("Download failed:", error);
            alert("Image download failed. Please try again.");
            downloadButton.textContent = originalDownloadText;
            downloadButton.disabled = false;
            generateButton.disabled = false;
            importButton.disabled = false;
        }
    }

    window.onload = () => {
        undertitleInput.value = "Undertitle";
        titleInput.value = "Main Title Here";
        authorInput.value = "Author";
        ctaText.value = "LEARN MORE";
        
        // Initialize the new sliders
        undertitleFontSizeInput.value = currentUndertitleFontSize;
        authorFontSizeInput.value = currentAuthorFontSize;

        drawCanvas();
    };
  </script>
</body>
</html>
